

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>chiripa.generate_pair_conformations &mdash; Chiripa -- CHI inteRactIon PArameter. 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Chiripa -- CHI inteRactIon PArameter.
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/generalintro.html">General introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/setupstructures.html">Setup structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/keywords.html">Chiripa keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/usermanual.html">USER MANUAL</a></li>
</ul>
<p class="caption"><span class="caption-text">API Python Packages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/api-docs.html">Python API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Chiripa -- CHI inteRactIon PArameter.</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>chiripa.generate_pair_conformations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for chiripa.generate_pair_conformations</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">chiripa</span> <span class="k">as</span> <span class="nn">chi</span>

<span class="c1"># #########################################################################</span>
<div class="viewcode-block" id="Zwork_per_core"><a class="viewcode-back" href="../../source/generate_pair_conformations.html#chiripa.generate_pair_conformations.Zwork_per_core">[docs]</a><span class="k">def</span> <span class="nf">Zwork_per_core</span><span class="p">(</span><span class="n">list_of_parameters</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a single Z using the list of parameters. This is used in parallel calculation of Z.</span>
<span class="sd">    This is called by ``_Z_calc_group`` function</span>


<span class="sd">    Args:</span>
<span class="sd">        list_of_parameters (list): List of the parameters.</span>


<span class="sd">    .. note:: Items in list of parameters (by position):</span>

<span class="sd">        * ``filenamecoords``: (list, string, 2-element) A 2-element lists containing the path to the coordinate files for each segment</span>
<span class="sd">        * ``filenametop``: (list, string, 2-element) A 2-element lists containing the path to the topology files for each segment</span>
<span class="sd">        * ``dirZ``: (string) Directory to store the pairwise structures generated during the process if ``Z_debug`` is ``True``</span>
<span class="sd">        * ``Z_samples`` (integer): Number of samples to average Z</span>
<span class="sd">        * ``Z_putTrialsMonomer`` (integer): Maximum number of trials to put a Segment</span>
<span class="sd">        * ``Z_nonbondedMethod`` (string): Non-bonded method</span>
<span class="sd">        * ``Z_Debug`` (Boolean). If ``True`` saves information in ``dirZ``</span>
<span class="sd">        * ``seed`` (integer): Seed for the random number generator.</span>


<span class="sd">    Returns:</span>
<span class="sd">        (tuple): tuple containing:</span>

<span class="sd">            * ``filenamecoords[0]`` (str) Name of the file containing the coordinatates of the Base segment.</span>
<span class="sd">            * ``filenamecoords[1]`` (str) Name of the file containing the coordinatates of the Screen segment.</span>
<span class="sd">            * ``Z_avg`` (float) Averaged Z-value.</span>
<span class="sd">            * ``Z_std`` (float) Standard deviation of the Z-value.</span>
<span class="sd">            * ``list_of_parameters[2]`` (str) Label &quot;11&quot;, &quot;12&quot;, &quot;21&quot; or &quot;22&quot;.</span>
<span class="sd">            * ``Z_hist`` (list) Returns the values of all calculated Z which can be uesed to build an histogram.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">filenamecoords</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">filenametop</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dirZ</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">Z_samples</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">Z_putTrialsMonomer</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">Z_nonbondedMethod</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">Z_debug</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">iseed</span> <span class="o">=</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>

    <span class="c1"># Segments to calculate the Z-number</span>
    <span class="n">s0</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">Segment</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span><span class="n">filecoord</span><span class="o">=</span><span class="n">filenamecoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filetop</span><span class="o">=</span><span class="n">filenametop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">Segment</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span><span class="n">filecoord</span><span class="o">=</span><span class="n">filenamecoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">filetop</span><span class="o">=</span><span class="n">filenametop</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># args = task_list</span>
    <span class="n">Z_avg</span><span class="p">,</span> <span class="n">Z_std</span><span class="p">,</span> <span class="n">Z_hist</span> <span class="o">=</span> <span class="n">calculate_average_z_number</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">samples_Z</span><span class="o">=</span><span class="n">Z_samples</span><span class="p">,</span>
                                <span class="n">putTrialsMonomer</span><span class="o">=</span><span class="n">Z_putTrialsMonomer</span><span class="p">,</span> <span class="n">idir</span><span class="o">=</span><span class="n">dirZ</span><span class="p">,</span>
                                <span class="n">box</span><span class="o">=</span><span class="n">chi</span><span class="o">.</span><span class="n">CubicBox</span><span class="p">(</span><span class="mf">40.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">),</span>
                                <span class="n">debug</span><span class="o">=</span><span class="n">Z_debug</span><span class="p">,</span>
                                <span class="n">iseed</span> <span class="o">=</span> <span class="n">iseed</span><span class="p">,</span>
                                <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="n">Z_nonbondedMethod</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">s0</span>
    <span class="k">del</span> <span class="n">s1</span>
    <span class="k">return</span> <span class="n">filenamecoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filenamecoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Z_avg</span><span class="p">,</span> <span class="n">Z_std</span><span class="p">,</span> <span class="n">list_of_parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">Z_hist</span></div>

<span class="c1"># #########################################################################</span>
<div class="viewcode-block" id="Z_calc_group"><a class="viewcode-back" href="../../source/generate_pair_conformations.html#chiripa.generate_pair_conformations.Z_calc_group">[docs]</a><span class="k">def</span> <span class="nf">Z_calc_group</span><span class="p">(</span><span class="n">filename_list</span><span class="p">,</span> <span class="n">filecoords_list</span><span class="p">,</span> <span class="n">filetop_list</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">Z_samples</span><span class="p">,</span> <span class="n">Z_putTrialsMonomer</span><span class="p">,</span>
                 <span class="n">Z_nonbondedMethod</span><span class="p">,</span> <span class="n">Z_debug</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">iseed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Group data to run in parallel the values of Z for each pair (&quot;11&quot;, &quot;12&quot;, &quot;21&quot;, &quot;22&quot;).</span>


<span class="sd">    Args:</span>
<span class="sd">        filecoords_list (list): A 2-element lists containing the path to the coordinate files for each segment.</span>
<span class="sd">        filetop_list (list): A 2-element lists containing the path to the topology files for each segment.</span>
<span class="sd">        logger (logger): Log results.</span>
<span class="sd">        Z_samples (int): int Number of samples to average Z.</span>
<span class="sd">        Z_putTrialsMonomer (int): Maximum number of trials to put a Segment.</span>
<span class="sd">        Z_nonbondedMethod (str): Non-bonded method.</span>
<span class="sd">        Z_Debug (bool): if ``True`` saves information in ``dirZ``.</span>
<span class="sd">        workers (int): Number of processes.</span>
<span class="sd">        iseed (int): Seed for the random number generator.</span>


<span class="sd">    Returns:</span>
<span class="sd">        results (list): A list containing the results of the Z calculation in parallel</span>


<span class="sd">    **Example of results**</span>

<span class="sd">    .. code-block::</span>

<span class="sd">        0 = {tuple: 6} (&#39;../data/n-hexane.pdb&#39;, &#39;../data/n-hexane.pdb&#39;, 10.6, 0.7999999999999999, &#39;11&#39;, [10, 12, 10, 11, 10])</span>
<span class="sd">        1 = {tuple: 6} (&#39;../data/n-hexane.pdb&#39;, &#39;../data/nitrobenzene.pdb&#39;, 9.2, 0.9797958971132713, &#39;12&#39;, [8, 9, 9, 11, 9])</span>
<span class="sd">        2 = {tuple: 6} (&#39;../data/nitrobenzene.pdb&#39;, &#39;../data/n-hexane.pdb&#39;, 9.8, 0.7483314773547883, &#39;21&#39;, [9, 9, 10, 10, 11])</span>
<span class="sd">        3 = {tuple: 6} (&#39;../data/nitrobenzene.pdb&#39;, &#39;../data/nitrobenzene.pdb&#39;, 9.4, 1.0198039027185568, &#39;22&#39;, [11, 9, 9, 10, 8])</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># *****************************</span>
    <span class="n">PROCESSES_AVAILABLE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
    <span class="n">NUMBER_OF_TASKS</span> <span class="o">=</span> <span class="n">workers</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> </span><span class="si">%d</span><span class="s2">/%m/%Y, %H:%M:%S&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Z_running_tmp.txt&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> </span><span class="si">%d</span><span class="s2">/%m/%Y, %H:%M:%S&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;Z calculation starting at </span><span class="si">{}</span><span class="s2"> using </span><span class="si">{:d}</span><span class="s2"> cores.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">),</span> <span class="n">workers</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="c1"># Write parameters  ===================================</span>
    <span class="n">message</span>  <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Starting time                                         = </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Number of samples to calculate coordination number(Z) = </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Z_samples</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Number of trials to put a Segment                     = </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Z_putTrialsMonomer</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Non-bonded method (VdW radii)                         = </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Z_nonbondedMethod</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Debug flag                                            = </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Z_debug</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Number of processes available                         = </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PROCESSES_AVAILABLE</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Number of tasks in parallel                           = </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NUMBER_OF_TASKS</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># Starting mp.pool ====================================</span>
    <span class="n">pool_tasks</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">NUMBER_OF_TASKS</span><span class="p">)</span>

    <span class="c1"># Create data =========================================</span>
    <span class="n">list_name</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filename_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">filename_list</span><span class="p">:</span>
            <span class="n">list_name</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

    <span class="n">list_coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filecoords_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">filecoords_list</span><span class="p">:</span>
            <span class="n">list_coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

    <span class="n">list_top</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filecoords_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">filecoords_list</span><span class="p">:</span>
            <span class="n">list_top</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">list_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">list_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">list_top</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="s2">&quot;./aZ11-coordination&quot;</span><span class="p">,</span> <span class="n">Z_samples</span><span class="p">,</span>
              <span class="n">Z_putTrialsMonomer</span><span class="p">,</span> <span class="n">Z_nonbondedMethod</span><span class="p">,</span> <span class="n">Z_debug</span><span class="p">,</span> <span class="n">iseed</span><span class="p">]</span> <span class="p">,</span>
             <span class="p">[</span><span class="n">list_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">list_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">list_top</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="s2">&quot;./aZ12-coordination&quot;</span><span class="p">,</span> <span class="n">Z_samples</span><span class="p">,</span>
              <span class="n">Z_putTrialsMonomer</span><span class="p">,</span> <span class="n">Z_nonbondedMethod</span><span class="p">,</span> <span class="n">Z_debug</span><span class="p">,</span> <span class="n">iseed</span><span class="p">]</span> <span class="p">,</span>
             <span class="p">[</span><span class="n">list_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">list_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">list_top</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;21&quot;</span><span class="p">,</span> <span class="s2">&quot;./aZ21-coordination&quot;</span><span class="p">,</span> <span class="n">Z_samples</span><span class="p">,</span>
              <span class="n">Z_putTrialsMonomer</span><span class="p">,</span> <span class="n">Z_nonbondedMethod</span><span class="p">,</span> <span class="n">Z_debug</span><span class="p">,</span> <span class="n">iseed</span><span class="p">]</span> <span class="p">,</span>
             <span class="p">[</span><span class="n">list_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">list_coords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">list_top</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;22&quot;</span><span class="p">,</span> <span class="s2">&quot;./aZ22-coordination&quot;</span><span class="p">,</span> <span class="n">Z_samples</span><span class="p">,</span>
              <span class="n">Z_putTrialsMonomer</span><span class="p">,</span> <span class="n">Z_nonbondedMethod</span><span class="p">,</span> <span class="n">Z_debug</span><span class="p">,</span> <span class="n">iseed</span><span class="p">]</span> <span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">pool_tasks</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Zwork_per_core</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>

    <span class="n">pool_tasks</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool_tasks</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">workers</span><span class="p">):</span>
        <span class="n">name1</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">name2</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">#Z# Z_</span><span class="si">{0:s}</span><span class="s2"> (</span><span class="si">{1:15s}</span><span class="s2"> / </span><span class="si">{2:15s}</span><span class="s2">) = </span><span class="si">{3:.2f}</span><span class="s2"> +- </span><span class="si">{4:.2f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">name1</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span>
                                                           <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="n">line</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">#Z# TIME: Z calculation in </span><span class="si">{:.1f}</span><span class="s2"> seconds using </span><span class="si">{:d}</span><span class="s2"> cores.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elapsed_time</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="n">workers</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Z_done.txt&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Z_running_tmp.txt&quot;</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;Z calculation done in </span><span class="si">{:.1f}</span><span class="s2"> seconds using </span><span class="si">{:d}</span><span class="s2"> cores.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elapsed_time</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="n">workers</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>

<span class="c1"># #########################################################################</span>
<span class="k">def</span> <span class="nf">write_Z_results</span><span class="p">(</span><span class="n">Z_results</span><span class="p">):</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Z_results.log&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Z_results</span><span class="p">:</span>
            <span class="n">name1</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">name2</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Z_</span><span class="si">{0:s}</span><span class="s2"> (</span><span class="si">{1:15s}</span><span class="s2"> / </span><span class="si">{2:15s}</span><span class="s2">) = </span><span class="si">{3:.2f}</span><span class="s2"> +- </span><span class="si">{4:.2f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">name1</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span>
                                                                                  <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Z_histogram.log&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">max_freq</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">infty</span>
        <span class="n">min_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">infty</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Z_results</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">zlist</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">zlist</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zlist</span><span class="p">)</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">zlist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_freq</span><span class="p">:</span> <span class="n">max_freq</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">min_freq</span><span class="p">:</span> <span class="n">min_freq</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;# Z_</span><span class="si">{0:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:d}</span><span class="s2"> </span><span class="si">{1:d}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ibin</span><span class="p">,</span> <span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">i</span><span class="o">+=</span> <span class="mi">1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">#print(hist[0], start, end, label)</span>

    <span class="n">create_gnu_histogram</span><span class="p">(</span><span class="n">max_freq</span><span class="p">,</span> <span class="n">min_freq</span><span class="p">)</span>

<span class="c1"># #########################################################################</span>
<span class="k">def</span> <span class="nf">create_gnu_histogram</span><span class="p">(</span><span class="n">max_freq</span><span class="p">,</span> <span class="n">min_freq</span><span class="p">):</span>

    <span class="n">lines</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">set term wxt 1 enhanced dashed size 800,800 font &quot;Arial,9&quot;</span>
<span class="s2">set multiplot layout 2,2</span>
<span class="s2">set encoding iso_8859_1</span>
<span class="s2">set style line 1 lt 1 ps 1.4 lc rgb &quot;black&quot;  pt 6 lw 2.0</span>
<span class="s2">set style line 2 lt 1 ps 1.4 lc rgb &quot;blue&quot;  pt 8 lw 2.0</span>
<span class="s2">set style line 3 lt 1 ps 1.4 lc rgb &quot;red&quot;  pt 10 lw 2.0</span>

<span class="s2">f1=&quot;./Z_histogram.log&quot;</span>

<span class="s2">set style data histogram</span>
<span class="s2">set style histogram cluster gap 2</span>
<span class="s2">set style fill solid</span>
<span class="s2">set boxwidth 1.0</span>
<span class="s2">set xtics rotate by 0</span>
<span class="s2">set yrange [</span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">]</span>
<span class="s2">set grid</span>

<span class="s2">p &quot;Z_histogram.log&quot; i 0 u 2:xtic(1) title &quot;Pair 1-1&quot; linecolor &quot;red&quot;</span>

<span class="s2">p &quot;Z_histogram.log&quot; i 1 u 2:xtic(1) title &quot;Pair 1-2&quot; linecolor &quot;blue&quot;</span>

<span class="s2">p &quot;Z_histogram.log&quot; i 2 u 2:xtic(1) title &quot;Pair 2-1&quot; linecolor &quot;green&quot;</span>

<span class="s2">p &quot;Z_histogram.log&quot; i 3 u 2:xtic(1) title &quot;Pair 2-2&quot; linecolor &quot;brown&quot;</span>

<span class="s2">unset multiplot</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">min_freq</span><span class="p">,</span> <span class="n">max_freq</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;histogram.gnu&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># #########################################################################</span>
<div class="viewcode-block" id="atoms_with_minimum_distances"><a class="viewcode-back" href="../../source/generate_pair_conformations.html#chiripa.generate_pair_conformations.atoms_with_minimum_distances">[docs]</a><span class="k">def</span> <span class="nf">atoms_with_minimum_distances</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the minimun distance between two set of atoms and return a list</span>
<span class="sd">    with the following format [iat_set1, iat_set2, distance]</span>

<span class="sd">   Args:</span>
<span class="sd">        s (Simulator): Simulator to perform the calculations</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if the instance is a simulator</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Simulator</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="si">{0:}</span><span class="s2"> is not a Simulator object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: gen_conf_fan_algorithm function needs a Simulator object&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Nothing is done, returning None&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="n">imol1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">imol2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ref</span> <span class="o">=</span> <span class="n">imol1</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">imol2</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>
    <span class="n">dij</span><span class="p">,</span> <span class="n">rijx</span><span class="p">,</span> <span class="n">rijy</span><span class="p">,</span> <span class="n">rijz</span> <span class="o">=</span> <span class="n">distance_array</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>

    <span class="n">min_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">dij</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;min_dist, np.where (dij == min_dist)&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">min_dist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span> <span class="p">(</span><span class="n">dij</span> <span class="o">==</span> <span class="n">min_dist</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====&quot;</span><span class="p">)</span></div>

<span class="c1"># #########################################################################</span>
<span class="k">def</span> <span class="nf">calc_single_anisotropy</span><span class="p">(</span><span class="n">central_mon</span><span class="p">,</span> <span class="n">neigh_mon</span><span class="p">,</span> <span class="n">nrotations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">nconf</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">CubicBox</span><span class="p">(</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span>
                           <span class="n">iseed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="s2">&quot;truhlar&quot;</span><span class="p">,</span> <span class="n">idir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">itry</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>


    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/anisotropy_full.pdb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idir</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/anisotropy_full.pdb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idir</span><span class="p">))</span>

    <span class="c1"># Seed for the random generator ========</span>
    <span class="k">if</span> <span class="n">iseed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iseed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">982628732</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>

    <span class="n">sim</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="p">(</span><span class="n">central_mon</span><span class="p">,</span> <span class="n">neigh_mon</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)</span>

    <span class="n">cog_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">iconf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nconf</span><span class="p">):</span>
        <span class="n">gen_conf_fan_algorithm_c</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">,</span> <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="n">nonbondedEvaluation</span><span class="p">)</span>
        <span class="n">cog_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">center_of_geom</span><span class="p">())</span>
        <span class="n">iseed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">write_PDB_simulator</span><span class="p">(</span><span class="n">filenamePDB</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/anisotropy_full.pdb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idir</span><span class="p">),</span><span class="n">box</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">box</span><span class="p">,</span>
                                    <span class="n">with_vmd_tcl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">appendpdb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">S_avg</span><span class="p">,</span> <span class="n">S_std</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">testPointInsidePyramid</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">Lx</span><span class="p">,</span> <span class="n">cog_list</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">,</span> <span class="n">nrotations</span><span class="o">=</span><span class="n">nrotations</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/acog_debug.xyz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idir</span><span class="p">,</span> <span class="n">itry</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cog_list</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;Mol</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cog_list</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;C </span><span class="si">{0:f}</span><span class="s2"> </span><span class="si">{1:f}</span><span class="s2"> </span><span class="si">{2:f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">sim</span>
    <span class="k">return</span> <span class="n">S_avg</span><span class="p">,</span> <span class="n">S_std</span>

<span class="c1"># #########################################################################</span>
<div class="viewcode-block" id="gen_conf_fan_algorithm"><a class="viewcode-back" href="../../source/generate_pair_conformations.html#chiripa.generate_pair_conformations.gen_conf_fan_algorithm">[docs]</a><span class="k">def</span> <span class="nf">gen_conf_fan_algorithm</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">iseed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chosen_solution</span><span class="o">=</span><span class="s2">&quot;MAX&quot;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function accepts a simulator object and then change the coordinates of the last molecule</span>
<span class="sd">    in the molecule list in accordance</span>
<span class="sd">    with the previous algorithm.</span>

<span class="sd">    Args:</span>
<span class="sd">        s (Simulator): Simulator to perform the calculations</span>
<span class="sd">        iseed (int): Seed for the random generator number</span>
<span class="sd">        chosen_solution (str): default=&quot;MAX&quot;, allowed values=(&quot;MAX&quot;, &quot;MIN&quot;, &quot;RANDOM&quot;). Blanco et al. shown that\</span>
<span class="sd">        the maximum and minimum solution can avoid the overlap between molecules. Fan et al. used the MAX</span>
<span class="sd">        mol_move (int). Number of the molecule to move. The followed order is that\</span>
<span class="sd">        in the mol_list of the simulator object</span>

<span class="sd">    Returns:</span>
<span class="sd">        r_max: (float)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if the instance is a simulator</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">chi</span><span class="o">.</span><span class="n">Simulator</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="si">{0:}</span><span class="s2"> is not a Simulator object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: gen_conf_fan_algorithm function needs a Simulator object&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Nothing is done, returning None&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Generate euler angles ========</span>
    <span class="k">if</span> <span class="n">iseed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">iseed</span><span class="p">)</span>

    <span class="c1"># Translate the center of geometry of the first and last monomers to the origin (0,0,0)</span>
    <span class="c1"># s.write_PDB_simulator(filenamePDB=&quot;./sim01.pdb&quot;,</span>
    <span class="c1">#                       title=&quot;Frame 01. Original&quot;,with_vmd_tcl=False, appendpdb=False)</span>
    <span class="n">nmols</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_nmolecules</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nmols</span><span class="p">,</span> <span class="n">nmols</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">imol</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">cog</span> <span class="o">=</span> <span class="n">imol</span><span class="o">.</span><span class="n">center_of_geom</span><span class="p">()</span>
        <span class="n">imol</span><span class="o">.</span><span class="n">translate_vector</span><span class="p">(</span><span class="o">-</span><span class="n">cog</span><span class="p">)</span>

    <span class="c1"># s.write_PDB_simulator(filenamePDB=&quot;./sim01.pdb&quot;,</span>
    <span class="c1">#                       title=&quot;Frame 02. Translate&quot;,with_vmd_tcl=True, appendpdb=True)</span>

    <span class="c1"># New orientation for the molecule 2 in the simulator object</span>
    <span class="n">imol1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">imol2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">imol2</span><span class="o">.</span><span class="n">euler_orientation</span><span class="p">(</span><span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">)</span>
    <span class="c1"># s.write_PDB_simulator(filenamePDB=&quot;./sim01.pdb&quot;,</span>
    <span class="c1">#                       title=&quot;Frame 03. Orientation&quot;,with_vmd_tcl=True, appendpdb=True)</span>

    <span class="c1"># Generate a vector on a sphere</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">point_on_unit_sphere</span><span class="p">(</span><span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">)</span>

    <span class="c1"># Calculate all distances between the atoms of mol1(i) and atoms of mol2(j)</span>
    <span class="c1"># Equation (10) --&gt; Fan et al. Macromolecules, 25(14), 1992, 3667-3676</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">imol1</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">imol2</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>

    <span class="n">elements1</span> <span class="o">=</span> <span class="n">imol1</span><span class="o">.</span><span class="n">_elements</span>
    <span class="n">elements2</span> <span class="o">=</span> <span class="n">imol2</span><span class="o">.</span><span class="n">_elements</span>
    <span class="n">dij</span><span class="p">,</span> <span class="n">rijx</span><span class="p">,</span> <span class="n">rijy</span><span class="p">,</span> <span class="n">rijz</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">distance_array</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
    <span class="n">sol_max</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">sol_min</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">index_mask</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># pij, rijx, rijy, rijz = distance_array_purepython(ref, conf)</span>
    <span class="c1"># print(np.testing.assert_almost_equal(dij, pij))</span>
    <span class="c1">#for i in range(imol1._natoms):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imol1</span><span class="o">.</span><span class="n">_natoms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">imol1</span><span class="o">.</span><span class="n">_dummy_head_atom</span><span class="p">,</span> <span class="n">imol1</span><span class="o">.</span><span class="n">_dummy_tail_atom</span><span class="p">]:</span>
            <span class="n">Rvdw_i</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">element_vdw_truhlar_radius</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">0.4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Rvdw_i</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">element_vdw_truhlar_radius</span><span class="p">[</span><span class="n">elements1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imol2</span><span class="o">.</span><span class="n">_natoms</span><span class="p">):</span>
            <span class="n">rij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rijx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">rijy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">rijz</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span>
            <span class="c1">#np.testing.assert_almost_equal(dij[i,j], np.linalg.norm(rij))</span>
            <span class="n">b</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">rij</span><span class="p">)</span>
            <span class="n">Rvdw_j</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">element_vdw_truhlar_radius</span><span class="p">[</span><span class="n">elements2</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">discriminat</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">-</span> <span class="n">dij</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">dij</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Rvdw_i</span> <span class="o">+</span> <span class="n">Rvdw_j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="c1">#print(i, j, elements1[i], elements2[j], Rvdw_i, Rvdw_j)</span>
            <span class="c1"># For real solutions get both solutions and store an global index in</span>
            <span class="c1"># index_mask. index_mask[0] = [0,2] : Global index 0 for the i-th 0 (local number in mol1)</span>
            <span class="c1">#                                     and    index 2 for the j-th 2 (local number in mol2)</span>
            <span class="k">if</span> <span class="n">discriminat</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">discriminat</span><span class="p">)</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">discriminat</span><span class="p">)</span>
                <span class="n">sol_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
                <span class="n">sol_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
                <span class="n">index_mask</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                <span class="c1">#print(i, j, dij[i,j], Rvdw_i, Rvdw_j, imol1.get_coords()[i], imol2.get_coords()[j],   discriminat, -b + math.sqrt(discriminat), -b - math.sqrt(discriminat))</span>
                <span class="c1">#print(i, j, discriminat, -b + math.sqrt(discriminat), -b - math.sqrt(discriminat))</span>

    <span class="c1"># Get the maximum (positive direction) and minimum (negative direction)</span>
    <span class="c1"># distance as well as the indexes of the atoms.</span>
    <span class="n">r_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sol_max</span><span class="p">)</span>
    <span class="n">i_max</span> <span class="o">=</span> <span class="n">index_mask</span><span class="p">[</span><span class="n">sol_max</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sol_max</span><span class="p">))]</span>
    <span class="n">r_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sol_min</span><span class="p">)</span>
    <span class="n">i_min</span> <span class="o">=</span> <span class="n">index_mask</span><span class="p">[</span><span class="n">sol_min</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">sol_min</span><span class="p">))]</span>

    <span class="c1"># New coordinates --&gt;</span>
    <span class="k">if</span> <span class="n">chosen_solution</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;MAX&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r_max</span>
    <span class="k">elif</span> <span class="n">chosen_solution</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;MIN&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r_min</span>
    <span class="k">elif</span> <span class="n">chosen_solution</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;RANDOM&quot;</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r_min</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r_max</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning </span><span class="si">{:s}</span><span class="s2"> is not allowed in generate_pair_conformations function. &quot;</span>
              <span class="s2">&quot;Using MAX as default.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chosen_solution</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r_max</span>

    <span class="c1"># Move molecule 2 alogn the vector r*n</span>
    <span class="n">imol2</span><span class="o">.</span><span class="n">translate_vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="c1"># s.write_PDB_simulator(filenamePDB=&quot;./sim01.pdb&quot;,</span>
    <span class="c1">#                       title=&quot;Frame 04. Move m2&quot;,with_vmd_tcl=True, appendpdb=True)</span>

    <span class="k">return</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">r_min</span><span class="p">,</span> <span class="n">i_max</span><span class="p">,</span> <span class="n">i_min</span></div>


<span class="c1"># #########################################################################</span>
<div class="viewcode-block" id="gen_conf_fan_algorithm_c"><a class="viewcode-back" href="../../source/generate_pair_conformations.html#chiripa.generate_pair_conformations.gen_conf_fan_algorithm_c">[docs]</a><span class="k">def</span> <span class="nf">gen_conf_fan_algorithm_c</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">iseed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">chosen_solution</span><span class="o">=</span><span class="s2">&quot;MAX&quot;</span><span class="p">,</span>
                             <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="s2">&quot;truhlar&quot;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solving the overlap problem using the algortihms exposed in :</span>

<span class="sd">    Molecular silverware. I. General solutions to excluded volume constrained problems</span>
<span class="sd">    (Blanco, M. Journal of Computational Chemistry, 1991, 12(2), 237-247</span>

<span class="sd">    Application of Molecular Simulation To Derive Phase Diagrams of Binary Mixtures</span>
<span class="sd">    (Fan C. et al. Macromolecules, 1992, 25(14), 3667-3676)</span>

<span class="sd">    The function accepts a simulator object and then change the coordinates of the last molecule</span>
<span class="sd">    in the molecule list in accordance</span>
<span class="sd">    with the previous algorithm.</span>

<span class="sd">    ``Parameters``:</span>
<span class="sd">        * **s** (type: Simulator): Simulator to perform the calculations</span>
<span class="sd">        * **iseed** (type int, default=None): Seed for the random generator number</span>
<span class="sd">        * **chosen_solution** (type: string, default=&quot;MAX&quot;, allowed values=(&quot;MAX&quot;, &quot;MIN&quot;, &quot;RANDOM&quot;). Blanco et al. shown that\</span>
<span class="sd">        the maximum and minimum solution can avoid the overlap between molecules. Fan et al. used the MAX</span>
<span class="sd">        * **mol_move** (type int, default=-1). Number of the molecule to move. The followed order is that\</span>
<span class="sd">        in the mol_list of the simulator object</span>

<span class="sd">    ``Returns``:</span>
<span class="sd">        * **r_max**</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if the instance is a simulator</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">chi</span><span class="o">.</span><span class="n">Simulator</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="si">{0:}</span><span class="s2"> is not a Simulator object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: gen_conf_fan_algorithm function needs a Simulator object&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Nothing is done, returning None&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Generate euler angles ========</span>
    <span class="k">if</span> <span class="n">iseed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">iseed</span><span class="p">)</span>

    <span class="c1"># Translate the center of geometry of the first and last monomers to the origin (0,0,0)</span>
    <span class="c1"># s.write_PDB_simulator(filenamePDB=&quot;./sim01.pdb&quot;,</span>
    <span class="c1">#                       title=&quot;Frame 01. Original&quot;,with_vmd_tcl=False, appendpdb=False)</span>
    <span class="n">nmols</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_nmolecules</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nmols</span><span class="p">,</span> <span class="n">nmols</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">imol</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">cog</span> <span class="o">=</span> <span class="n">imol</span><span class="o">.</span><span class="n">center_of_geom</span><span class="p">()</span>
        <span class="n">imol</span><span class="o">.</span><span class="n">translate_vector</span><span class="p">(</span><span class="o">-</span><span class="n">cog</span><span class="p">)</span>

    <span class="c1"># s.write_PDB_simulator(filenamePDB=&quot;./sim01.pdb&quot;,</span>
    <span class="c1">#                       title=&quot;Frame 02. Translate&quot;,with_vmd_tcl=True, appendpdb=True)</span>

    <span class="c1"># New orientation for the molecule 2 in the simulator object</span>
    <span class="n">imol1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">imol2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">imol2</span><span class="o">.</span><span class="n">euler_orientation</span><span class="p">(</span><span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">)</span>
    <span class="c1"># s.write_PDB_simulator(filenamePDB=&quot;./sim01.pdb&quot;,</span>
    <span class="c1">#                       title=&quot;Frame 03. Orientation&quot;,with_vmd_tcl=True, appendpdb=True)</span>

    <span class="c1"># Generate a vector on a sphere</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">point_on_unit_sphere</span><span class="p">(</span><span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">)</span>

    <span class="c1"># Calculate all distances between the atoms of mol1(i) and atoms of mol2(j)</span>
    <span class="c1"># Equation (10) --&gt; Fan et al. Macromolecules, 25(14), 1992, 3667-3676</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">imol1</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">imol2</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>
    <span class="n">elements1</span> <span class="o">=</span> <span class="n">imol1</span><span class="o">.</span><span class="n">_elements</span>
    <span class="n">elements2</span> <span class="o">=</span> <span class="n">imol2</span><span class="o">.</span><span class="n">_elements</span>

    <span class="n">Rvdw_i</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Rvdw_j</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">nonbondedEvaluation</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;TRUHLAR&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imol1</span><span class="o">.</span><span class="n">_natoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">imol1</span><span class="o">.</span><span class="n">_dummy_head_atom</span><span class="p">,</span> <span class="n">imol1</span><span class="o">.</span><span class="n">_dummy_tail_atom</span><span class="p">]:</span>
                <span class="n">Rvdw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi</span><span class="o">.</span><span class="n">element_vdw_truhlar_radius</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Rvdw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi</span><span class="o">.</span><span class="n">element_vdw_truhlar_radius</span><span class="p">[</span><span class="n">elements1</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imol2</span><span class="o">.</span><span class="n">_natoms</span><span class="p">):</span>
             <span class="n">Rvdw_j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi</span><span class="o">.</span><span class="n">element_vdw_truhlar_radius</span><span class="p">[</span><span class="n">elements2</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>

        <span class="n">r_max</span><span class="p">,</span> <span class="n">r_min</span><span class="p">,</span> <span class="n">i_max</span><span class="p">,</span> <span class="n">i_min</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">calc_discriminant</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">imol1</span><span class="o">.</span><span class="n">_natoms</span><span class="p">,</span> <span class="n">imol2</span><span class="o">.</span><span class="n">_natoms</span><span class="p">,</span> <span class="n">Rvdw_i</span><span class="p">,</span> <span class="n">Rvdw_j</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">nonbondedEvaluation</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OKUWAKI_CORRECTION&quot;</span><span class="p">:</span>
        <span class="n">ref_typeelements</span> <span class="o">=</span> <span class="n">imol1</span><span class="o">.</span><span class="n">_typeelements</span>
        <span class="n">conf_typeelements</span> <span class="o">=</span> <span class="n">imol2</span><span class="o">.</span><span class="n">_typeelements</span>
        <span class="n">dij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">imol1</span><span class="o">.</span><span class="n">_natoms</span><span class="p">,</span> <span class="n">imol2</span><span class="o">.</span><span class="n">_natoms</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imol1</span><span class="o">.</span><span class="n">_natoms</span><span class="p">):</span>
            <span class="n">itype</span> <span class="o">=</span> <span class="n">ref_typeelements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imol2</span><span class="o">.</span><span class="n">_natoms</span><span class="p">):</span>
                <span class="n">jtype</span> <span class="o">=</span> <span class="n">conf_typeelements</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">str1</span> <span class="o">=</span> <span class="n">itype</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">jtype</span>
                <span class="n">str2</span> <span class="o">=</span> <span class="n">jtype</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">itype</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dij</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">distances_revaluated_Okuwaki</span><span class="p">[</span><span class="n">str1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dij</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">distances_revaluated_Okuwaki</span><span class="p">[</span><span class="n">str2</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gen_conf_fan_algorithm_c cannot be used.&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Method: </span><span class="si">{:}</span><span class="s2"> is not defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nonbondedEvaluation</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available methods are: truhlar and okuwaki_correction&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">r_max</span><span class="p">,</span> <span class="n">r_min</span><span class="p">,</span> <span class="n">i_max</span><span class="p">,</span> <span class="n">i_min</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">calc_discriminant_okuwaki</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">imol1</span><span class="o">.</span><span class="n">_natoms</span><span class="p">,</span> <span class="n">imol2</span><span class="o">.</span><span class="n">_natoms</span><span class="p">,</span> <span class="n">dij</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gen_conf_fan_algorithm_c cannot be used.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Method: </span><span class="si">{:}</span><span class="s2"> is not defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nonbondedEvaluation</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available methods are: truhlar and okuwaki_correction&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c1"># Get the maximum (positive direction) and minimum (negative direction)</span>
    <span class="c1"># distance as well as the indexes of the atoms.</span>

    <span class="c1"># New coordinates --&gt;</span>
    <span class="k">if</span> <span class="n">chosen_solution</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;MAX&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r_max</span>
    <span class="k">elif</span> <span class="n">chosen_solution</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;MIN&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r_min</span>
    <span class="k">elif</span> <span class="n">chosen_solution</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;RANDOM&quot;</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r_min</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r_max</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning </span><span class="si">{:s}</span><span class="s2"> is not allowed in generate_pair_conformations function. &quot;</span>
              <span class="s2">&quot;Using MAX as default.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chosen_solution</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r_max</span>

    <span class="c1"># Move molecule 2 along the vector r*n</span>
    <span class="n">imol2</span><span class="o">.</span><span class="n">translate_vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="c1"># s.write_PDB_simulator(filenamePDB=&quot;./sim01.pdb&quot;,</span>
    <span class="c1">#                       title=&quot;Frame 04. Move m2&quot;,with_vmd_tcl=True, appendpdb=True)</span>
    <span class="k">return</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">r_min</span><span class="p">,</span> <span class="n">i_max</span><span class="p">,</span> <span class="n">i_min</span></div>


<span class="c1"># #########################################################################</span>
<div class="viewcode-block" id="point_on_unit_sphere"><a class="viewcode-back" href="../../source/generate_pair_conformations.html#chiripa.generate_pair_conformations.point_on_unit_sphere">[docs]</a><span class="k">def</span> <span class="nf">point_on_unit_sphere</span><span class="p">(</span><span class="n">iseed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;Understanding Molecular Simulation&quot;, Frenkel-Smith, 2nEdition</span>
<span class="sd">    Algorithm 42 (Random Vector on a Unit Sphere), Pag 578</span>

<span class="sd">    A random vector on a sphere of diameter 1 (origin 0,0,0)</span>

<span class="sd">    :param iseed</span>
<span class="sd">    :return: Point on a unit sphere from xcenter</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">iseed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">iseed</span><span class="p">)</span>

    <span class="n">ransq</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">ran1</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">ran2</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">ransq</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ran1</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">ran2</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">ransq</span> <span class="o">=</span> <span class="n">ran1</span><span class="o">*</span><span class="n">ran1</span> <span class="o">+</span> <span class="n">ran2</span><span class="o">*</span><span class="n">ran2</span>

    <span class="n">ranh</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">ransq</span><span class="p">)</span>

    <span class="n">bx</span><span class="o">=</span><span class="n">ran1</span><span class="o">*</span><span class="n">ranh</span>
    <span class="n">by</span><span class="o">=</span><span class="n">ran2</span><span class="o">*</span><span class="n">ranh</span>
    <span class="n">bz</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">ransq</span><span class="p">)</span>

    <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">point</span></div>


<span class="c1"># #########################################################################</span>
<div class="viewcode-block" id="calculate_single_z_number"><a class="viewcode-back" href="../../source/generate_pair_conformations.html#chiripa.generate_pair_conformations.calculate_single_z_number">[docs]</a><span class="k">def</span> <span class="nf">calculate_single_z_number</span><span class="p">(</span><span class="n">central_mon</span><span class="p">,</span> <span class="n">neigh_mon</span><span class="p">,</span> <span class="n">ntry</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                              <span class="n">iseed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">chi</span><span class="o">.</span><span class="n">CubicBox</span><span class="p">(</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span>
                              <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="s2">&quot;truhlar&quot;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculate the coordination number Z using the algorithm</span>
<span class="sd">    proposed by Fan et al. Macromolecules, 25(14), 1992, 3667-3676.</span>

<span class="sd">    The Z number is calculated using a nearest neighouurs around a center molecule.</span>
<span class="sd">    The algorithm is as follows:</span>

<span class="sd">        1. Generate  the Simulator object with the central monomer and the</span>
<span class="sd">        first position for the other monomer</span>
<span class="sd">        2. Try to put the next neighbour around the central monomer</span>
<span class="sd">        2.1. Get the neighbour position around the central monomer (gen_conf_fan_algorithm)</span>
<span class="sd">        2.2. Check overlap</span>
<span class="sd">        2.3. if overlap = False. z=z+1 and go to step 2</span>
<span class="sd">        2.4. if overlap = True &amp; itry &lt; ntry --&gt; Go to step 2.1</span>
<span class="sd">        2.5. if overlap = True &amp; itry &gt; ntry --&gt; Go to step 3</span>
<span class="sd">        3. There is no more room for a new position</span>

<span class="sd">    Parameters:</span>

<span class="sd">        central_mon: (type: Segment): Central monomer</span>
<span class="sd">        neigh_mon: (type: Segment): Neighbour monomer</span>
<span class="sd">        ntry: (type: integer, default: 2000): Number of trials to put the neighbour monomer around the central monomer</span>
<span class="sd">        iseed: (type: integer, default:None): Seed for the random number generator (RNG). The value\</span>
<span class="sd">         ``None`` is given to get a seed value from random.seed() which uses the current\</span>
<span class="sd">        time to generate it. Otherwise, use iseed as intial value for the seed RNG.</span>

<span class="sd">    Returns:</span>

<span class="sd">        z: (type: float) Number of coordination</span>
<span class="sd">        sim: (type: Simulator) Simulator containing the coordination configuration</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">iseed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iseed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">982628732</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>

    <span class="n">sim</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="p">(</span><span class="n">central_mon</span><span class="p">,</span> <span class="n">neigh_mon</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span> <span class="n">box</span><span class="p">)</span>
    <span class="n">chi</span><span class="o">.</span><span class="n">gen_conf_fan_algorithm_c</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">)</span>

    <span class="n">seed</span> <span class="o">=</span> <span class="n">iseed</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">z_coord</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">itry</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Get a copy of the last monomer</span>
        <span class="n">m_new</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Add the monomer to the simulator</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">add_molecule</span><span class="p">(</span><span class="n">m_new</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">i_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">gen_conf_fan_algorithm_c</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">iseed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="n">nonbondedEvaluation</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">central_mon</span><span class="o">.</span><span class="n">_dummy_head_atom</span><span class="p">,</span> <span class="n">central_mon</span><span class="o">.</span><span class="n">_dummy_tail_atom</span><span class="p">]:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">seed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isoverlapping</span> <span class="o">=</span> <span class="n">check_overlap_z_number</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="n">nonbondedEvaluation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">isoverlapping</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">seed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">itry</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">itry</span><span class="o">&gt;</span><span class="n">ntry</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itry</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">z_coord</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">z_coord</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= WARNING ============&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coordination number (Z) &gt;100 &quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Likely something is going wrong&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please, check calculate_single_z_number function.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= WARNING ============&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">seed</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">z_coord</span><span class="p">,</span> <span class="n">sim</span></div>


<span class="c1"># #########################################################################</span>
<span class="k">def</span> <span class="nf">calculate_average_z_number</span><span class="p">(</span><span class="n">c_mon</span><span class="p">,</span> <span class="n">n_mon</span><span class="p">,</span> <span class="n">samples_Z</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                               <span class="n">putTrialsMonomer</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">iseed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">idir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">chi</span><span class="o">.</span><span class="n">CubicBox</span><span class="p">(</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span>
                               <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="s2">&quot;truhlar&quot;</span><span class="p">):</span>

    <span class="c1"># Copy of the segments to be sure that they are different instances</span>
    <span class="c1"># The function works with the copies.</span>
    <span class="n">central_mon</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">c_mon</span><span class="p">)</span>
    <span class="n">neigh_mon</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">n_mon</span><span class="p">)</span>

    <span class="c1"># Check if the monomers contain type atom information when</span>
    <span class="c1"># using the reevaluated distances proposed by Okuwaki et al.</span>
    <span class="k">if</span> <span class="n">nonbondedEvaluation</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OKUWAKI_CORRECTION&quot;</span><span class="p">:</span>
        <span class="n">typeelements1</span> <span class="o">=</span> <span class="n">central_mon</span><span class="o">.</span><span class="n">_typeelements</span>
        <span class="n">typeelements2</span> <span class="o">=</span> <span class="n">neigh_mon</span><span class="o">.</span><span class="n">_typeelements</span>
        <span class="n">settype1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">settype2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">typeelements1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">settype1</span> <span class="o">=</span> <span class="s2">&quot;Not None&quot;</span>
        <span class="k">if</span> <span class="n">typeelements2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">settype2</span> <span class="o">=</span> <span class="s2">&quot;Not None&quot;</span>
        <span class="k">if</span> <span class="n">typeelements1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">typeelements2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overlap cannot be evaluated.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Method: </span><span class="si">{:}</span><span class="s2"> requires information of type atoms.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nonbondedEvaluation</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set type atoms through the set_typeatoms function of the Segment class&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Central Segment: </span><span class="si">{:}</span><span class="s2"> --&gt; </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">central_mon</span><span class="o">.</span><span class="n">_filecoord</span><span class="p">,</span> <span class="n">settype1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Neigh   Segment: </span><span class="si">{:}</span><span class="s2"> --&gt; </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">neigh_mon</span><span class="o">.</span><span class="n">_filecoord</span><span class="p">,</span> <span class="n">settype2</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c1"># Print each 10% the time</span>
    <span class="c1"># stride = int(samples_Z / 10)</span>
    <span class="c1"># if stride == 0: stride = 1</span>
    <span class="c1"># print(&quot;\t{:d} trials for coordination number {} and {}.\n\tPrinting info each {} trials&quot;.</span>
    <span class="c1">#       format(samples_Z, central_mon._filecoord, neigh_mon._filecoord, stride))</span>

    <span class="n">z_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">itry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_Z</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">calculate_single_z_number</span><span class="p">(</span><span class="n">central_mon</span><span class="p">,</span> <span class="n">neigh_mon</span><span class="p">,</span>
                                           <span class="n">ntry</span><span class="o">=</span><span class="n">putTrialsMonomer</span><span class="p">,</span> <span class="n">iseed</span> <span class="o">=</span> <span class="n">iseed</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span>
                                           <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="n">nonbondedEvaluation</span><span class="p">)</span>
        <span class="n">z_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># if itry == 0 or (itry+1) % stride == 0.0 or itry == samples_Z-1:</span>
        <span class="c1">#     end_time = datetime.datetime.now()</span>
        <span class="c1">#     elapsed_time = end_time - start_time</span>
        <span class="c1">#     print(&quot;\t {} of {} trials in {:.1f} seconds. PID: {}&quot;.format(itry+1,samples_Z, elapsed_time.total_seconds(), os.getpid()))</span>
        <span class="c1">#     print(&quot;{} {}\n&quot;.format(central_mon._filecoord, neigh_mon._filecoord))</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">path_Z_PDB</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/coordinationXX2b_</span><span class="si">{:04d}</span><span class="s2">.pdb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idir</span><span class="p">,</span> <span class="n">itry</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">write_PDB_simulator</span><span class="p">(</span><span class="n">filenamePDB</span><span class="o">=</span><span class="n">path_Z_PDB</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">with_vmd_tcl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">idir</span><span class="p">)</span>

    <span class="n">Z_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">z_list</span><span class="p">)</span>
    <span class="n">Z_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">z_list</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">z_list</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">z_list</span><span class="p">)</span>
    <span class="c1">#Z_hist  = np.histogram(z_list, bins=b-a+1, range=[a,b], density=False)</span>
    <span class="k">return</span> <span class="n">Z_avg</span><span class="p">,</span> <span class="n">Z_std</span> <span class="p">,</span> <span class="n">z_list</span>


<span class="c1"># #########################################################################</span>
<span class="k">def</span> <span class="nf">check_overlap_z_number</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="s2">&quot;truhlar&quot;</span><span class="p">):</span>

    <span class="n">overlap</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># The current molecule to be put in the coordination sphere</span>
    <span class="n">imol_current</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ref_coord</span> <span class="o">=</span> <span class="n">imol_current</span><span class="o">.</span><span class="n">_coords</span>
    <span class="n">ref_elements</span> <span class="o">=</span> <span class="n">imol_current</span><span class="o">.</span><span class="n">_elements</span>
    <span class="n">iatoms</span> <span class="o">=</span> <span class="n">imol_current</span><span class="o">.</span><span class="n">_natoms</span>
    <span class="k">if</span> <span class="n">nonbondedEvaluation</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OKUWAKI_CORRECTION&quot;</span><span class="p">:</span>
        <span class="n">ref_typeelements</span> <span class="o">=</span> <span class="n">imol_current</span><span class="o">.</span><span class="n">_typeelements</span>

    <span class="c1"># Molecules just placed in the coordinate sphere</span>
    <span class="n">nmols_to_check</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_nmolecules</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">jatoms</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">conf_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">conf_elements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">conf_typeelements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nmols_to_check</span><span class="p">):</span>
        <span class="n">jmol_placed</span> <span class="o">=</span>  <span class="n">s</span><span class="o">.</span><span class="n">get_ith_molecule</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">tmp_coord</span> <span class="o">=</span> <span class="n">jmol_placed</span><span class="o">.</span><span class="n">_coords</span>
        <span class="n">tmp_elements</span> <span class="o">=</span> <span class="n">jmol_placed</span><span class="o">.</span><span class="n">_elements</span>
        <span class="n">conf_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">conf_coord</span><span class="p">,</span><span class="n">tmp_coord</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">conf_elements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">conf_elements</span><span class="p">,</span><span class="n">tmp_elements</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">jatoms</span> <span class="o">+=</span> <span class="n">jmol_placed</span><span class="o">.</span><span class="n">_natoms</span>
        <span class="n">tmp_typeelements</span> <span class="o">=</span> <span class="n">jmol_placed</span><span class="o">.</span><span class="n">_typeelements</span>
        <span class="k">if</span> <span class="n">nonbondedEvaluation</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OKUWAKI_CORRECTION&quot;</span><span class="p">:</span>
            <span class="n">conf_typeelements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">conf_typeelements</span><span class="p">,</span><span class="n">tmp_typeelements</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># All distances between the atoms in the molecule to be put and the rest of atoms</span>
    <span class="c1"># already placed.</span>
    <span class="c1"># TODO: This can be optimized due to is not neccesary to calculate all distances</span>
    <span class="c1"># in the case of overlapping structures.</span>
    <span class="n">dij</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">distance_array</span><span class="p">(</span><span class="n">ref_coord</span><span class="p">,</span> <span class="n">conf_coord</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nonbondedEvaluation</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;TRUHLAR&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iatoms</span><span class="p">):</span>
            <span class="n">Rvdw_i</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">element_vdw_truhlar_radius</span><span class="p">[</span><span class="n">ref_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jatoms</span><span class="p">):</span>
                <span class="n">Rvdw_j</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">element_vdw_truhlar_radius</span><span class="p">[</span><span class="n">conf_elements</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">dij</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Rvdw_i</span><span class="o">+</span><span class="n">Rvdw_j</span><span class="p">:</span>
                    <span class="n">overlap</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="n">nonbondedEvaluation</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OKUWAKI_CORRECTION&quot;</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iatoms</span><span class="p">):</span>
            <span class="n">itype</span> <span class="o">=</span> <span class="n">ref_typeelements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jatoms</span><span class="p">):</span>
                <span class="n">jtype</span> <span class="o">=</span> <span class="n">conf_typeelements</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">str1</span> <span class="o">=</span> <span class="n">itype</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">jtype</span>
                <span class="n">str2</span> <span class="o">=</span> <span class="n">jtype</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">itype</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">distances_revaluated_Okuwaki</span><span class="p">[</span><span class="n">str1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">distances_revaluated_Okuwaki</span><span class="p">[</span><span class="n">str2</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overlap cannot be evaluated.&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Method: </span><span class="si">{:}</span><span class="s2"> is not defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nonbondedEvaluation</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available methods are: truhlar and okuwaki_correction&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">dij</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">overlap</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overlap cannot be evaluated.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Method: </span><span class="si">{:}</span><span class="s2"> is not defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nonbondedEvaluation</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available methods are: truhlar and okuwaki_correction&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ERROR ============&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">overlap</span>





<span class="c1"># #########################################################################</span>
<span class="k">def</span> <span class="nf">calculate_average_anisotropy</span><span class="p">(</span><span class="n">c_mon</span><span class="p">,</span> <span class="n">n_mon</span><span class="p">,</span> <span class="n">orientations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">nconf</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                        <span class="n">box</span><span class="o">=</span> <span class="n">chi</span><span class="o">.</span><span class="n">CubicBox</span><span class="p">(</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span> <span class="n">idir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                        <span class="n">iseed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="s2">&quot;truhlar&quot;</span> <span class="p">):</span>


    <span class="c1"># Seed for the random generator ========</span>
    <span class="k">if</span> <span class="n">iseed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iseed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">982628732</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>

    <span class="c1"># Copy of the segments to be sure that they are different instances</span>
    <span class="c1"># The function works with the copies.</span>
    <span class="n">central_mon</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">c_mon</span><span class="p">)</span>
    <span class="n">neigh_mon</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">n_mon</span><span class="p">)</span>

    <span class="c1"># Print each 25% the time</span>
    <span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">orientations</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stride</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{:d}</span><span class="s2"> orientations (conf: </span><span class="si">{:d}</span><span class="s2">) for anisotropy factor of </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">.</span><span class="se">\n\t</span><span class="s2">Printing info each </span><span class="si">{}</span><span class="s2"> trials&quot;</span><span class="o">.</span>
          <span class="nb">format</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">nconf</span><span class="p">,</span> <span class="n">central_mon</span><span class="o">.</span><span class="n">_filecoord</span><span class="p">,</span> <span class="n">neigh_mon</span><span class="o">.</span><span class="n">_filecoord</span><span class="p">,</span> <span class="n">stride</span><span class="p">))</span>

    <span class="n">S_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">orientations</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">orientations</span><span class="p">):</span>
        <span class="n">central_mon</span><span class="o">.</span><span class="n">euler_orientation</span><span class="p">(</span><span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">)</span>
        <span class="n">S_avg</span><span class="p">,</span> <span class="n">S_std</span> <span class="o">=</span> <span class="n">calc_single_anisotropy</span><span class="p">(</span><span class="n">central_mon</span><span class="p">,</span> <span class="n">neigh_mon</span><span class="p">,</span> <span class="n">nconf</span><span class="o">=</span><span class="n">nconf</span><span class="p">,</span>
                                   <span class="n">iseed</span><span class="o">=</span><span class="n">iseed</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
                                   <span class="n">nonbondedEvaluation</span><span class="o">=</span><span class="n">nonbondedEvaluation</span><span class="p">,</span> <span class="n">itry</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="n">S_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_avg</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">stride</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">orientations</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2"> trials in </span><span class="si">{:.1f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">orientations</span><span class="p">,</span>
                                                                <span class="n">elapsed_time</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>


    <span class="k">return</span> <span class="n">S_array</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">S_array</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, J.Ramos

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>